{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-black flex flex-col items-center justify-center p-4 relative overflow-hidden">
    
    <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/90 to-transparent">
        <div class="text-white">
            <p class="text-xs opacity-70 uppercase tracking-widest font-bold text-azul-inst">Estudiante</p>
            <p class="font-bold text-lg">{{ current_user.nombre }}</p>
        </div>
        
        <div class="flex gap-3">
            <a href="{{ url_for('student.perfil') }}" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-azul-inst transition-colors border border-white/10">
                <i class="fas fa-user-cog"></i>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-red-500 transition-colors border border-white/10">
                <i class="fas fa-power-off"></i>
            </a>
        </div>
    </div>

    <div class="w-full max-w-sm relative flex flex-col items-center">
        <div class="w-full aspect-square relative rounded-3xl overflow-hidden border-2 border-white/20 shadow-2xl shadow-azul-inst/30 bg-gray-900">
            <canvas id="canvas" class="w-full h-full object-cover" style="display: none;"></canvas>
            
            <div id="loadingMessage" class="absolute inset-0 flex flex-col items-center justify-center text-white text-sm p-4 text-center z-20">
                <i class="fas fa-camera text-3xl mb-3 animate-pulse text-azul-inst"></i>
                <span id="statusText">Configurando visor...</span>
            </div>
            
            <div class="absolute top-0 left-0 w-full h-1 bg-azul-inst/80 shadow-[0_0_20px_rgba(0,100,255,0.8)] animate-scan z-30 pointer-events-none"></div>
            <div class="absolute inset-4 border-2 border-white/10 rounded-2xl pointer-events-none z-30"></div>
        </div>

        <p class="text-white text-center mt-4 text-sm opacity-60">Apunta al código QR para registrar asistencia</p>

        <div class="flex items-center w-full my-6">
            <div class="h-px bg-white/20 flex-1"></div>
            <span class="px-3 text-white/40 text-xs font-bold uppercase">O ingresa el código</span>
            <div class="h-px bg-white/20 flex-1"></div>
        </div>

        <div class="w-full flex gap-2">
            <input type="text" id="inputCodigo" placeholder="EJ: A1B2" maxlength="10"
                   class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-center font-mono text-lg tracking-widest uppercase focus:outline-none focus:border-azul-inst transition-all">
            
            <button id="btnEnviarManual" class="bg-white text-black font-bold px-6 py-3 rounded-xl hover:bg-azul-inst hover:text-white transition-colors">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <form id="qr-form" method="POST" action="{{ url_for('student.procesar_qr') }}" class="hidden">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="token" id="token-input">
    </form>
</div>

<script src="{{ url_for('static', filename='js/jsQR.min.js') }}"></script>

<script nonce="{{ csp_nonce() }}">
    const video = document.createElement("video");
    const canvasElement = document.getElementById("canvas");
    const canvas = canvasElement.getContext("2d", { willReadFrequently: true });
    const loadingMessage = document.getElementById("loadingMessage");
    const statusText = document.getElementById("statusText");
    const tokenInput = document.getElementById("token-input");
    const qrForm = document.getElementById("qr-form");

    // Iniciar el flujo de la cámara
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            video.setAttribute("playsinline", true); // Crucial para navegadores móviles
            await video.play();
            requestAnimationFrame(tick);
        } catch (err) {
            console.error("Acceso denegado a la cámara:", err);
            statusText.innerHTML = "<span class='text-red-400'>Error: Permisos de cámara denegados.</span>";
        }
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // Ocultar mensaje y mostrar canvas de inmediato
            loadingMessage.style.display = "none";
            canvasElement.style.display = "block";

            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code && code.data) {
                // Si el código es válido, enviar el formulario
                tokenInput.value = code.data;
                qrForm.submit();
                return; // Detener el ciclo de animación
            }
        }
        requestAnimationFrame(tick);
    }

    // Listener para envío manual
    document.getElementById('btnEnviarManual').addEventListener('click', () => {
        const val = document.getElementById('inputCodigo').value.toUpperCase().trim();
        if(val) {
            tokenInput.value = val;
            qrForm.submit();
        }
    });

    document.addEventListener('DOMContentLoaded', startCamera);
</script>

<style>
    @keyframes scan {
        0% { top: 0%; opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { top: 100%; opacity: 0; }
    }
    .animate-scan {
        animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
</style>
{% endblock %}