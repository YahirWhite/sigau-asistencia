{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-black flex flex-col items-center justify-center p-4 relative overflow-hidden">
    
    <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/90 to-transparent">
        <div class="text-white">
            <p class="text-xs opacity-70 uppercase tracking-widest font-bold">Estudiante</p>
            <p class="font-bold text-lg text-azul-inst">{{ current_user.nombre }}</p>
        </div>
        
        <div class="flex gap-3">
            <a href="{{ url_for('student.perfil') }}" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-azul-inst transition-colors relative border border-white/10">
                <i class="fas fa-user-cog"></i>
                {% if inscripciones_abiertas %}
                <span class="absolute top-0 right-0 w-3 h-3 bg-green-500 border-2 border-black rounded-full animate-pulse"></span>
                {% endif %}
            </a>

            <a href="{{ url_for('auth.logout') }}" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-red-500 transition-colors border border-white/10">
                <i class="fas fa-power-off"></i>
            </a>
        </div>
    </div>

    <div class="w-full max-w-sm relative mt-[-20px] flex flex-col items-center">
        
        <div class="w-full aspect-square relative rounded-3xl overflow-hidden border-2 border-white/20 shadow-2xl shadow-azul-inst/30 bg-gray-900">
            <div id="reader" class="w-full h-full"></div>
            
            <div class="absolute top-0 left-0 w-full h-1 bg-azul-inst/80 shadow-[0_0_20px_rgba(0,100,255,0.8)] animate-scan z-10 pointer-events-none"></div>
            
            <div class="absolute top-4 left-4 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-lg opacity-80 pointer-events-none"></div>
            <div class="absolute top-4 right-4 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-lg opacity-80 pointer-events-none"></div>
            <div class="absolute bottom-4 left-4 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-lg opacity-80 pointer-events-none"></div>
            <div class="absolute bottom-4 right-4 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-lg opacity-80 pointer-events-none"></div>
        </div>

        <p class="text-white text-center mt-4 text-sm opacity-60">
            Apunta la c치mara al c칩digo QR del profesor
        </p>

        <div class="flex items-center w-full my-6">
            <div class="h-px bg-white/20 flex-1"></div>
            <span class="px-3 text-white/40 text-xs font-bold uppercase">O ingresa el c칩digo</span>
            <div class="h-px bg-white/20 flex-1"></div>
        </div>

        <div class="w-full flex gap-2">
            <input type="text" id="inputCodigo" placeholder="Ej: A1B2" maxlength="10"
                   class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white text-center font-mono text-lg tracking-widest uppercase focus:outline-none focus:border-azul-inst focus:bg-white/20 placeholder-white/30 transition-all">
            
            <button id="btnEnviarManual" 
                    class="bg-white text-black font-bold px-6 py-3 rounded-xl hover:bg-azul-inst hover:text-white transition-colors">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

    </div>

    <form id="qr-form" method="POST" action="{{ url_for('student.procesar_qr') }}" class="hidden">
        <input type="hidden" name="token" id="token-input">
    </form>

</div>

<script nonce="{{ csp_nonce() }}">
    // 1. Audio Local (Debes descargar el mp3 a static/audio/beep.mp3)
    const beepSound = new Audio("{{ url_for('static', filename='audio/beep.mp3') }}"); 
    let html5QrCode;

    function enviarToken(token) {
        if (!token) return;
        try {
            beepSound.play().catch(e => console.log("Audio bloqueado o no encontrado"));
        } catch (e) {}
        
        document.getElementById('token-input').value = token;
        document.getElementById('qr-form').submit();
    }

    function iniciarCamara() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { 
            fps: 15, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            (decodedText) => {
                html5QrCode.stop().then(() => {
                    enviarToken(decodedText);
                });
            }
        ).catch(err => {
            console.error("Error de c치mara trasera, intentando frontal:", err);
            html5QrCode.start({ facingMode: "user" }, config, (decodedText) => {
                html5QrCode.stop().then(() => enviarToken(decodedText));
            });
        });
    }

    function enviarManual() {
        const codigo = document.getElementById('inputCodigo').value.toUpperCase().trim();
        if(codigo) enviarToken(codigo);
    }

    // 2. Event Listeners (Reemplazan a los onchange/onclick del HTML)
    document.addEventListener('DOMContentLoaded', () => {
        iniciarCamara();
        
        const btnManual = document.getElementById('btnEnviarManual');
        if (btnManual) {
            btnManual.addEventListener('click', enviarManual);
        }
    });
</script>

<style>
    #reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
    }
    @keyframes scan {
        0% { top: 0%; opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { top: 100%; opacity: 0; }
    }
    .animate-scan {
        animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
</style>
{% endblock %}